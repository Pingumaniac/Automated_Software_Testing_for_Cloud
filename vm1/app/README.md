# Test Metrics and Code Descriptions

## 1. Functional Metrics

### 1.1 CRUD Operation Metrics
* **Insert Latency (ms)**: Measure the time taken to insert a single document or batch of documents.
* **Query Latency (ms)**: Evaluate the time taken to retrieve documents based on primary key lookup, range queries, compound key lookups, or text search queries (if indexes are enabled).
* **Update Latency (ms)**: Measure the time to update one or more fields in existing documents.
* **Delete Latency (ms)**: Measure the time to delete documents based on specific criteria.

### 1.2 Replica Set Metrics
* **Replication Lag (ms)**: Time difference between when a write is applied to the primary node and when it is replicated to secondaries.

## 2. Performance Metrics

### 2.1 Throughput
* **Operations per Second (ops/s)**: Measure the number of CRUD operations MongoDB can process per second under a specific workload.

### 2.2 Resource Utilisation
* **CPU Utilisation (%)**: Measure CPU usage under various workloads.
* **Memory Utilisation (%)**: Track memory usage during read and write-intensive operations.
* **Disk I/O (MB/s)**: Monitor disk reads/writes during heavy data insertions or queries.

## 3. Reliability Metrics

### 3.1 Fault Tolerance
* **Failover Time (ms)**: Measure the time taken for the replica set to elect a new primary when the current primary fails.
* **Data Consistency**: Verify consistency between primary and secondary nodes under normal operations and after failover.

### 3.2 Durability
* **Data Loss on Failure**: Measure the extent of data loss (if any) under sudden node or cluster failures.

## 4. Fuzz Testing Metrics

### 4.1 Resilience
* **Crash Rate (% of operations)**: Percentage of operations causing crashes during fuzz testing.

### 4.2 Vulnerability Metrics
* **Edge Case Coverage**: Number and variety of edge cases detected during fuzz testing.
* **Execution Paths Tested**: Percentage of code paths executed during fuzz testing.

## 5. Benchmark Metrics

### 5.1 Load Testing
* **Sustained Performance**: Measure system performance over an extended period (e.g., 1-hour test).

## 6. Database Schema

### 6.1 Account Collection
* **_id**: `ObjectId` (automatically generated by MongoDB)
* **accountID**: `String` (unique identifier, e.g., UUID)
* **isAdmin**: `Boolean` (indicates if the account has admin privileges)
* **created_at**: `Date`
* **updated_at**: `Date`

### 6.2 User Collection
* **_id**: `ObjectId`
* **accountID**: `String` (Reference to `Account.accountID`)
* **name**: `String`
* **birthday**: `Date`
* **nationality**: `String`
* **gender**: `String` (e.g., Male, Female, Other)
* **ethnicity**: `String`
* **created_at**: `Date`
* **updated_at**: `Date`

### 6.3 Admin Collection
* **_id**: `ObjectId`
* **accountID**: `String` (Reference to `Account.accountID`)
* **name**: `String`
* **birthday**: `Date`
* **nationality**: `String`
* **gender**: `String`
* **ethnicity**: `String`
* **role**: `String` (e.g., SuperAdmin, Moderator)
* **created_at**: `Date`
* **updated_at**: `Date`

### 6.4 Messages Collection
* **_id**: `ObjectId`
* **senderID**: `String` (Reference to `Account.accountID`)
* **receiverID**: `String` (Reference to `Account.accountID`)
* **content**: `String`
* **sent_time**: `Date`
* **read_time**: `Date` (nullable)
* **status**: `String` (e.g., Sent, Delivered, Read)
* **created_at**: `Date`
* **updated_at**: `Date`

**Relationships:**
* Each `User` and `Admin` is associated with an `Account` via `accountID`.
* `Messages` reference `Account.accountID` for both `senderID` and `receiverID`, allowing messages between any accounts, whether `User` or `Admin`.

## 7. Instructions to Execute the Software

### 7.1 Prerequisites

1. Follow [this](app/README.md) to set up everything.

### 7.2 Data Generation

1. **Generate Sample Data:**
   - Run the data generation script to populate the MongoDB database with `Account`, `User`, `Admin`, and `Messages` documents.
     ```
     python generate_data.py
     ```

### 7.3 Running Unit Tests

1. **Execute Unit Tests:**
   - Run all unit tests to validate CRUD operations and ensure data integrity across collections.
     ```
     pytest test_unit.py
     ```

   - **Generate Coverage Report (Optional):**
     ```
     pytest --cov=test_lib --cov-report=term-missing test_unit.py
     ```

### 7.4 Running AFL++ Test

1. **Fuzz Testing for Account Collection:**
   - **Prepare Seed Inputs:**
     ```
     mkdir -p afl_inputs_account
     echo '{
         "accountID": "123e4567-e89b-12d3-a456-426614174000",
         "isAdmin": false,
         "created_at": "2023-01-01T12:00:00",
         "updated_at": "2023-01-01T12:00:00"
     }' > afl_inputs_account/account_valid.json

     echo '{
         "accountID": 12345,
         "isAdmin": "yes",
         "created_at": "invalid_date",
         "updated_at": "2023-01-01T12:00:00"
     }' > afl_inputs_account/account_malformed.json
     ```

   - **Run AFL++ Fuzzing:**
     ```
     afl-fuzz -i afl_inputs_account -o afl_outputs_account -- python test_aflplusplus.py
     ```

### 7.5 Running Atheris Test

1. **Prepare Seed Inputs:**
   - Create a directory for Atheris seed inputs and populate it with valid and malformed JSON examples:
     ```
     mkdir -p input_dir_atheris

     echo '{
         "accountID": "123e4567-e89b-12d3-a456-426614174000",
         "isAdmin": false,
         "created_at": "2023-01-01T12:00:00Z",
         "updated_at": "2023-01-01T12:00:00Z"
     }' > input_dir_atheris/seed_insert.json

     echo '{
         "accountID": "123e4567-e89b-12d3-a456-426614174000"
     }' > input_dir_atheris/seed_query.json

     echo '{
         "accountID": "123e4567-e89b-12d3-a456-426614174000",
         "role": "Administrator"
     }' > input_dir_atheris/seed_update.json

     echo '{
         "_id": "507f1f77bcf86cd799439011"
     }' > input_dir_atheris/seed_delete.json
     ```

2. **Run Atheris Fuzzing:**
   - Execute the Atheris fuzzing script:
     ```
     python -m atheris app/test_atheris.py
     ```

   - Atheris will continuously generate and mutate inputs for the fuzzing target functions until manually stopped. To terminate the process, press `Ctrl + C`.

### 7.6 Analyzing Results

1. **Review Metrics and Logs:**
   - **Unit Tests:** Inspect `metrics.json` for performance metrics and `crashes.json` for details on any failures.
   - **AFL++ Fuzz Testing:** Examine `metrics_aflplusplus.json` for metrics related to AFL++ fuzzing and look for crash-inducing inputs in the `afl_outputs_account/crashes/` directory.
   - **Atheris Fuzz Testing:** Review `metrics_atheris.json` for coverage-guided fuzz testing metrics and crash reports.

2. **Generate Visualizations:**
   - Use the appropriate plotting script to generate visual metrics:
     - **Unit Tests:**
       ```
       python plot_metrics_unit.py
       ```
     - **AFL++ Fuzz Testing:**
       ```
       python plot_metrics_aflplusplus.py
       ```
     - **Atheris Fuzz Testing:**
       ```
       python plot_metrics_atheris.py
       ```

   - All generated plots will be saved in the `plots/` directory for further analysis.

3. **Inspect Crash Files:**
   - For AFL++ crashes, navigate to the crash files in the `afl_outputs_account/crashes/` directory:
     ```
     ls afl_outputs_account/crashes
     ```
   - Reproduce a crash by feeding the input back to the fuzzing script:
     ```
     python test_aflplusplus.py < afl_outputs_account/crashes/id_000000
     ```

## 8. Code Descriptions

### Scripts

1. **`database_setup.py`**: Initializes the MongoDB database and sets up the necessary collections (`Account`, `User`, `Admin`, and `Messages`). This script ensures that the MongoDB replica set is correctly configured and populated with the required schema before running any tests or fuzzing operations.

2. **`test_unit.py`**: Contains unit tests to validate MongoDB’s core functionalities, including CRUD operations and replica set configurations. This script measures metrics such as latency, throughput, and resource utilization, logging the results in `metrics.json`.

3. **`plot_metrics_unit.py`**: Generates visualizations from `metrics.json`, which is created during unit testing. This script produces PNG plots for CRUD operation latencies, throughput, CPU utilization, memory utilization, and disk I/O. The plots are saved in the `plots/` directory for analysis and reporting.

4. **`test_aflplusplus.py`**: Performs advanced fuzz testing of MongoDB CRUD operations using AFL++. It generates malformed or random inputs to uncover vulnerabilities or stability issues, logging metrics in `metrics_aflplusplus.json`.

5. **`plot_metrics_aflplusplus.py`**: Creates visualizations from `metrics_aflplusplus.json`, which is generated during AFL++ fuzz testing. It produces PNG plots for operation latencies, throughput, CPU and memory usage, disk I/O, and crash rates, providing insights into MongoDB’s robustness under fuzzed inputs.

6. **`test_atheris.py`**: Uses Google’s Atheris to conduct coverage-guided fuzz testing of MongoDB CRUD operations. This script generates and mutates inputs to identify edge cases and potential vulnerabilities, logging results in `metrics_atheris.json`.

7. **`plot_metrics_atheris.py`**: Generates visualizations from `metrics_atheris.json`, created during Atheris fuzz testing. It produces PNG plots for CRUD operation latencies, throughput, resource utilization, and crash rates, saved in the `plots/` directory.

8. **`generate_data.py`**: Populates the MongoDB database with sample data for the `Account`, `User`, `Admin`, and `Messages` collections. This script helps simulate realistic data for testing and fuzzing scenarios.

### 9. Additional Files and Directories

- **`requirements.txt`**: Lists all the necessary Python dependencies required to run the scripts and tests. Install them using:
  ```
  pip install -r requirements.txt
  ```

- **`metrics.json`**: Log file generated during unit testing. It contains performance and reliability metrics such as CRUD operation latencies, throughput, and resource utilization.

- **`metrics_aflplusplus.json`**: Log file created during AFL++ fuzz testing. This file logs metrics such as latencies, throughput, CPU and memory usage, and crash events.

- **`metrics_atheris.json`**: Log file produced during Atheris fuzz testing. It tracks similar metrics to `metrics_aflplusplus.json`, including operation latencies, throughput, and crash events.

- **`crashes.json`**: Log file that records details of crash events encountered during unit and fuzz testing. This file provides valuable insights into inputs that caused crashes.

- **`generated_docs/`**: Directory containing JSON documents generated for testing purposes. These documents simulate realistic and malformed inputs for CRUD operations.

- **`afl_inputs_account/`**: Directory containing seed input files for fuzz testing the `Account` collection. Seed inputs are critical for initiating fuzz testing processes in AFL++.

- **`afl_outputs_account/`**: Directory where AFL++ stores outputs such as unique test cases and crash-inducing inputs. This directory is essential for analyzing AFL++ fuzz testing results.

- **`plots/`**: Directory that stores PNG plots generated by the plotting scripts (`plot_metrics_unit.py`, `plot_metrics_aflplusplus.py`, and `plot_metrics_atheris.py`). These visualizations provide a graphical representation of the collected metrics.

