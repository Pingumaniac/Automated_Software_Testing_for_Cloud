# Test Metrics and Code Descriptions

## 1. Functional Metrics

### 1.1 CRUD Operation Metrics
* **Insert Latency (ms)**: Measure the time taken to insert a single document or batch of documents.
* **Query Latency (ms)**: Evaluate the time taken to retrieve documents based on primary key lookup, range queries, compound key lookups, or text search queries (if indexes are enabled).
* **Update Latency (ms)**: Measure the time to update one or more fields in existing documents.
* **Delete Latency (ms)**: Measure the time to delete documents based on specific criteria.

### 1.2 Replica Set Metrics
* **Replication Lag (ms)**: Time difference between when a write is applied to the primary node and when it is replicated to secondaries.

## 2. Performance Metrics

### 2.1 Throughput
* **Operations per Second (ops/s)**: Measure the number of CRUD operations MongoDB can process per second under a specific workload.

### 2.2 Resource Utilization
* **CPU Utilization (%)**: Measure CPU usage under various workloads.
* **Memory Utilization (%)**: Track memory usage during read and write-intensive operations.
* **Disk I/O (MB/s)**: Monitor disk reads/writes during heavy data insertions or queries.

## 3. Reliability Metrics

### 3.1 Fault Tolerance
* **Failover Time (ms)**: Measure the time taken for the replica set to elect a new primary when the current primary fails.
* **Data Consistency**: Verify consistency between primary and secondary nodes under normal operations and after failover.

### 3.2 Durability
* **Data Loss on Failure**: Measure the extent of data loss (if any) under sudden node or cluster failures.

## 4. Fuzz Testing Metrics

### 4.1 Resilience
* **Crash Rate (% of operations)**: Percentage of operations causing crashes during fuzz testing.

### 4.2 Vulnerability Metrics
* **Edge Case Coverage**: Number and variety of edge cases detected during fuzz testing.
* **Execution Paths Tested**: Percentage of code paths executed during fuzz testing.

## 5. Benchmark Metrics

### 5.1 Load Testing
* **Sustained Performance**: Measure system performance over an extended period (e.g., 1-hour test).

## 6. Database Schema

### 6.1 Account Collection
* **_id**: `ObjectId` (automatically generated by MongoDB)
* **accountID**: `String` (unique identifier, e.g., UUID)
* **isAdmin**: `Boolean` (indicates if the account has admin privileges)
* **created_at**: `Date`
* **updated_at**: `Date`

### 6.2 User Collection
* **_id**: `ObjectId`
* **accountID**: `String` (Reference to `Account.accountID`)
* **name**: `String`
* **birthday**: `Date`
* **nationality**: `String`
* **gender**: `String` (e.g., Male, Female, Other)
* **ethnicity**: `String`
* **created_at**: `Date`
* **updated_at**: `Date`

### 6.3 Admin Collection
* **_id**: `ObjectId`
* **accountID**: `String` (Reference to `Account.accountID`)
* **name**: `String`
* **birthday**: `Date`
* **nationality**: `String`
* **gender**: `String`
* **ethnicity**: `String`
* **role**: `String` (e.g., SuperAdmin, Moderator)
* **created_at**: `Date`
* **updated_at**: `Date`

### 6.4 Messages Collection
* **_id**: `ObjectId`
* **senderID**: `String` (Reference to `Account.accountID`)
* **receiverID**: `String` (Reference to `Account.accountID`)
* **content**: `String`
* **sent_time**: `Date`
* **read_time**: `Date` (nullable)
* **status**: `String` (e.g., Sent, Delivered, Read)
* **created_at**: `Date`
* **updated_at**: `Date`

**Relationships:**
* Each `User` and `Admin` is associated with an `Account` via `accountID`.
* `Messages` reference `Account.accountID` for both `senderID` and `receiverID`, allowing messages between any accounts, whether `User` or `Admin`.

## 7. Instructions to Execute the Software

### 7.1 Prerequisites

1. Follow [this](app/README.md) to set up everything.

### 7.3 Data Generation

1. **Generate Sample Data:**
   - Run the data generation script to populate the MongoDB database with `Account`, `User`, `Admin`, and `Messages` documents.
     ```
     python generate_data.py
     ```

### 7.4 Running Unit Tests

1. **Execute Unit Tests:**
   - Run all unit tests to validate CRUD operations and ensure data integrity across collections.
     ```
     pytest test_unit.py
     ```

   - **Generate Coverage Report (Optional):**
     ```
     pytest --cov=test_lib --cov-report=term-missing test_unit.py
     ```

### 7.5 Running Fuzz Tests

1. **Fuzz Testing for Account Collection:**
   - **Prepare Seed Inputs:**
     ```
     mkdir -p afl_inputs_account
     echo '{
         "accountID": "123e4567-e89b-12d3-a456-426614174000",
         "isAdmin": false,
         "created_at": "2023-01-01T12:00:00",
         "updated_at": "2023-01-01T12:00:00"
     }' > afl_inputs_account/account_valid.json

     echo '{
         "accountID": 12345,
         "isAdmin": "yes",
         "created_at": "invalid_date",
         "updated_at": "2023-01-01T12:00:00"
     }' > afl_inputs_account/account_malformed.json
     ```

   - **Run AFL++ Fuzzing:**
     ```
     afl-fuzz -i afl_inputs_account -o afl_outputs_account -- python fuzz_account.py
     ```

   - **Alternatively, Use the Automation Script:**
     ```
     ./run_fuzzing.sh
     ```

2. **Fuzz Testing for Other Collections:**
   - Repeat similar steps for `User`, `Admin`, and `Messages` collections by creating respective fuzzing scripts (e.g., `fuzz_user.py`, `fuzz_admin.py`, `fuzz_messages.py`) and seed inputs.

### 7.6 Analyzing Results

1. **Review Metrics and Crash Logs:**
   - Check `metrics.json` for latency and performance metrics.
   - Check `crashes.json` for any crashes detected during fuzz testing.

2. **Generate Visualizations:**
   - Run the plotting script to create visual representations of the collected metrics.
     ```
     python plot_metrics.py
     ```
   - Generated plots will be saved in the `plots/` directory.

3. **Inspect Crash Files:**
   - Navigate to the `afl_outputs_account/crashes/` directory to review crash-inducing inputs.
     ```
     ls afl_outputs_account/crashes
     ```
   - Reproduce a crash by feeding the input back to the fuzzing script:
     ```
     python fuzz_account.py < afl_outputs_account/crashes/id_000000
     ```

### 7.7 Automating the Testing Process

1. **Run Fuzzing for a Specified Duration:**
   - Use the `run_fuzzing.sh` script to automate fuzz testing runs.
     ```
     ./run_fuzzing.sh
     ```

2. **Integrate with CI/CD Pipelines:**
   - Incorporate fuzz testing and unit tests into your Continuous Integration workflows to ensure ongoing code quality and resilience.

## 8. Code Descriptions

### Scripts

1. **`test_unit.py`**: Contains unit tests to validate MongoDB’s core functionalities, including CRUD operations and replica set configurations. These tests ensure MongoDB operates as expected in both standalone and replica set modes.

2. **`test_simple_fuzz.py`**: A simple fuzz testing script that performs CRUD operations using randomly generated data. This script is designed to assess MongoDB’s resilience to unexpected or edge-case inputs by inserting, updating, and deleting randomized documents.

3. **`test_afl.py`**: Integrates American Fuzzy Lop (AFL) for advanced fuzz testing. This script generates malformed or random inputs to identify vulnerabilities or stability issues in MongoDB, helping ensure robustness under diverse data conditions.

4. **`test_performance.py`**: A script designed to evaluate MongoDB’s performance. It captures metrics such as response time and throughput.

5. **`mongo_client.py`**: A MongoDB client manager that handles connection logic and CRUD operations. This file provides a streamlined API for other components to interact with the MongoDB replica set.

6. **`random_json_generator.py`**: A utility for generating random JSON documents with diverse data types, ideal for testing MongoDB with varying input. It’s particularly useful for stress and fuzz testing scenarios, where data variability is essential.

7. **`generate_data.py`**: Script to generate and insert sample data into MongoDB, including `Account`, `User`, `Admin`, and `Messages` documents.

8. **`fuzz_account.py`**: Fuzz testing script tailored to the `Account` collection. It generates and inserts fuzzed `Account` documents to test the resilience and security of the `Account` collection.

9. **`run_fuzzing.sh`**: Shell script to automate the fuzzing process for the `Account` collection. It prepares seed inputs, starts AFL++ fuzzing, runs it for a specified duration, and then terminates the fuzzing process.

10. **`plot_metrics.py`**: Generates visualizations from `metrics.json` and `crashes.json` to help analyze performance and crash data.

### Additional Files and Directories

11. **`requirements.txt`**: Lists all necessary Python packages required to run the scripts and tests.

12. **`metrics.json` & `crashes.json`**: Log files that store metrics and crash events, respectively, for later analysis and visualization.

13. **`generated_docs/`**: Directory to store generated JSON documents for optional inspection and verification.

14. **`afl_inputs_account/`**: Directory containing seed input files for fuzzing the `Account` collection.

15. **`afl_outputs_account/`**: Directory where AFL++ stores findings related to the `Account` fuzzing, including crashes and unique test cases.
