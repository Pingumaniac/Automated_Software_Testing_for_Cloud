# Test Metrics and Code Descriptions

## 1. Functional Metrics

### 1.1 CRUD Operation Metrics
* **Insert Latency (ms)**: Measure the time taken to insert a single document or batch of documents.
* **Query Latency (ms)**: Evaluate the time taken to retrieve documents based on primary key lookup, range queries, compound key lookups, or text search queries (if indexes are enabled).
* **Update Latency (ms)**: Measure the time to update one or more fields in existing documents.
* **Delete Latency (ms)**: Measure the time to delete documents based on specific criteria.

### 1.2 Replica Set Metrics
* **Replication Lag (ms)**: Time difference between when a write is applied to the primary node and when it is replicated to secondaries.

## 2. Performance Metrics

### 2.1 Throughput
* **Operations per Second (ops/s)**: Measure the number of CRUD operations MongoDB can process per second under a specific workload.

### 2.2 Resource Utilisation
* **CPU Utilisation (%)**: Measure CPU usage under various workloads.
* **Memory Utilisation (%)**: Track memory usage during read and write-intensive operations.
* **Disk I/O (MB/s)**: Monitor disk reads/writes during heavy data insertions or queries.

## 3. Reliability Metrics

### 3.1 Durability
* **Data Loss on Failure**: Measure the extent of data loss (if any) under sudden node or cluster failures.

## 4. Fuzz Testing Metrics

### 4.1 Resilience
* **Crash Rate (% of operations)**: Percentage of operations causing crashes during fuzz testing.

### 4.2 Vulnerability Metrics
* **Edge Case Coverage**: Number and variety of edge cases detected during fuzz testing.
* **Execution Paths Tested**: Percentage of code paths executed during fuzz testing.

## 5. Benchmark Metrics

### 5.1 Load Testing
* **Sustained Performance**: Measure system performance over an extended period (e.g., 1-hour test).

## 6. Database Schema

### 6.1 Account Collection
* **_id**: `ObjectId` (automatically generated by MongoDB)
* **accountID**: `String` (unique identifier, e.g., UUID)
* **isAdmin**: `Boolean` (indicates if the account has admin privileges)
* **created_at**: `Date`
* **updated_at**: `Date`

### 6.2 User Collection
* **_id**: `ObjectId`
* **accountID**: `String` (Reference to `Account.accountID`)
* **name**: `String`
* **birthday**: `Date`
* **nationality**: `String`
* **gender**: `String` (e.g., Male, Female, Other)
* **ethnicity**: `String`
* **created_at**: `Date`
* **updated_at**: `Date`

### 6.3 Admin Collection
* **_id**: `ObjectId`
* **accountID**: `String` (Reference to `Account.accountID`)
* **name**: `String`
* **birthday**: `Date`
* **nationality**: `String`
* **gender**: `String`
* **ethnicity**: `String`
* **role**: `String` (e.g., SuperAdmin, Moderator)
* **created_at**: `Date`
* **updated_at**: `Date`

### 6.4 Messages Collection
* **_id**: `ObjectId`
* **senderID**: `String` (Reference to `Account.accountID`)
* **receiverID**: `String` (Reference to `Account.accountID`)
* **content**: `String`
* **sent_time**: `Date`
* **read_time**: `Date` (nullable)
* **status**: `String` (e.g., Sent, Delivered, Read)
* **created_at**: `Date`
* **updated_at**: `Date`

**Relationships:**
* Each `User` and `Admin` is associated with an `Account` via `accountID`.
* `Messages` reference `Account.accountID` for both `senderID` and `receiverID`, allowing messages between any accounts, whether `User` or `Admin`.

## 7. Instructions to Execute the Software

### 7.1 Prerequisites

1. Follow [this](app/README.md) to set up everything.

### 7.2 Access the Kubernetes Pod
```
kubectl exec -it python-mongo-client -- /bin/bash
```

### 7.3 Run the Python codes inside the pod sequentially
```
python3 test.py
python3 database_setup.py
pytest --cov=test_lib --cov-report=term-missing test_unit.py
python3 test_atheris.py -max_len=1024
```

### 7.4 Analyzing Results

1. **Review Metrics and Logs:**
   - **Unit Tests:** Inspect `metrics.json` for performance metrics and `crashes.json` for details on any failures.
   - **Atheris Fuzz Testing:** Review `metrics_atheris.json` for coverage-guided fuzz testing metrics and crash reports.

2. **Visualise data:**
   - Use the appropriate plotting script to generate visual metrics:
     - **Unit Tests:**
       ```
       python plot_metrics_unit.py
       ```
     - **Atheris Fuzz Testing:**
       ```
       python plot_metrics_atheris.py
       ```

   - All generated plots will be saved in the `plots/` directory for further analysis.

### 7.5 Exit the Pod
```
exit
```

## 8. Code Descriptions

### Scripts

1. **`database_setup.py`**: Initializes the MongoDB database and sets up the necessary collections (`Account`, `User`, `Admin`, and `Messages`). This script ensures that the MongoDB replica set is correctly configured and populated with the required schema before running any tests or fuzzing operations.

2. **`test_unit.py`**: Contains unit tests to validate MongoDB’s core functionalities, including CRUD operations and replica set configurations. This script measures metrics such as latency, throughput, and resource utilization, logging the results in `metrics_unit.json`.

3. **`plot_metrics_unit.py`**: Generates visualizations from `metrics.json`, which is created during unit testing. This script produces PNG plots for CRUD operation latencies, throughput, CPU utilization, memory utilization, and disk I/O. The plots are saved in the `plots/` directory for analysis and reporting.

4. **`test_atheris.py`**: Performs advanced fuzz testing of MongoDB CRUD operations using Atheris. It generates malformed or random inputs to uncover vulnerabilities or stability issues, logging metrics in `metrics_atheris.json`.

5. **`plot_metrics_atheris.py`**: Creates visualizations from `metrics_atheris.json`, which is generated during Atheris fuzz testing. It produces PNG plots for operation latencies, throughput, CPU and memory usage, disk I/O, and crash rates, providing insights into MongoDB’s robustness under fuzzed inputs.

6. **`generate_data.py`**: Populates the MongoDB database with sample data for the `Account`, `User`, `Admin`, and `Messages` collections. This script helps simulate realistic data for testing and fuzzing scenarios.

### 9. Additional Files and Directories

- **`requirements.txt`**: Lists all the necessary Python dependencies required to run the scripts and tests. Install them using:
  ```
  pip install -r requirements.txt
  ```

- **`metrics_unit.json`**: Log file generated during unit testing. It contains performance and reliability metrics such as CRUD operation latencies, throughput, and resource utilization.

- **`metrics_atheris.json`**: Log file created during Atheris fuzz testing. This file logs metrics such as crash rate, edge case coverage, and execution paths tested.

- **`crashes.json`**: Log file that records details of crash events encountered during unit and fuzz testing. This file provides valuable insights into inputs that caused crashes.

- **`json/`**: Directory containing JSON documents generated for testing purposes.

- **`img/`**: Directory that stores PNG plots generated.
